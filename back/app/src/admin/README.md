# Админка для микросервисной архитектуры

## Обзор

Админка настроена для работы с микросервисной архитектурой, где пользователи управляются отдельным auth-сервисом. Основные особенности:

1. **Аутентификация через auth-сервис** - логин и проверка прав происходит через HTTP API
2. **Обогащение пользовательскими данными** - информация о пользователях загружается батч-запросами
3. **Кэширование в сессии** - токены и данные пользователей кэшируются для производительности

## Компоненты админки

### AdminAuth
Класс аутентификации, который:
- Проверяет логин/пароль через auth-сервис
- Кэширует токены доступа в сессии
- Проверяет права суперпользователя
- Валидирует сессии при каждом запросе

### AuthServiceMixin
Миксин для обогащения данных пользователями:
- Батч-загрузка информации о пользователях
- Кэширование результатов
- Обработка ошибок сети

### Представления моделей
Все модели имеют специализированные представления с:
- Правильным отображением полей
- Поиском и сортировкой
- Локализованными названиями
- Иконками для навигации

## Настройка аутентификации auth-сервиса

### Требуемые эндпоинты в auth-сервисе

#### 1. Аутентификация для админки
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "admin@example.com",
  "password": "password"
}
```

Ответ:
```json
{
  "id": "uuid",
  "username": "admin",
  "email": "admin@example.com",
  "first_name": "Admin",
  "last_name": "User",
  "is_superuser": true,
  "is_active": true,
  "access_token": "jwt_token_here"
}
```

#### 2. Проверка токена
```http
GET /api/v1/auth/me
Authorization: Bearer <access_token>
```

#### 3. Выход
```http
POST /api/v1/auth/logout
Authorization: Bearer <access_token>
```

### Уже реализованные эндпоинты
- `GET /api/v1/users/{user_id}/` - получение пользователя по ID
- `POST /api/v1/users/batch/` - батч-получение пользователей
- `POST /api/v1/users/exists/` - проверка существования пользователей

## Модели админки

### Курсы и обучение
- **CourseAdminView** - управление курсами
- **CourseTopicAdminView** - темы курсов
- **LessonAdminView** - уроки

### Группы и записи
- **GroupAdminView** - группы обучения
- **EnrollmentAdminView** - записи студентов в группы (с обогащением пользовательскими данными)

### Задания и тестирование
- **AssignmentAdminView** - задания
- **SubmissionAdminView** - отправки заданий (с информацией о студентах)
- **QuestionBlockAdminView** - блоки вопросов
- **QuestionAdminView** - вопросы
- **AnswerOptionAdminView** - варианты ответов

### Оценки и обратная связь
- **GradeAdminView** - оценки (с информацией о преподавателях)
- **CommentAdminView** - комментарии (с информацией о преподавателях)

### Прогресс обучения
- **ProgressAdminView** - прогресс студентов

## Особенности работы

### Обогащение пользовательскими данными
Модели с полями `user_id`, `student_id`, `teacher_id` автоматически обогащаются информацией о пользователях:

```python
# Вместо UUID отображается:
"Иван Иванов (ivan_user)"

# При ошибке сети:
"Пользователь uuid-here"
```

### Обработка ошибок
- Если auth-сервис недоступен, админка работает с ограниченным функционалом
- Пользовательские данные заменяются на UUID
- Логин может быть невозможен при недоступности auth-сервиса

### Производительность
- Батч-запросы для получения пользователей
- Кэширование токенов в сессии
- Пагинация по 25 записей
- Оптимизированные запросы к БД

## Требования к окружению

### Переменные окружения
```bash
# В .env файле
AUTH_SERVICE_URL=http://auth:8000
AUTH_SERVICE_TIMEOUT=30.0
AUTH_SERVICE_MAX_BATCH_SIZE=100
```

### Docker Compose
```yaml
main:
  environment:
    - AUTH_SERVICE_URL=http://auth:8000
  depends_on:
    - auth
```

## Безопасность

### Права доступа
- Только суперпользователи могут входить в админку
- Проверка прав происходит при каждом запросе
- Токены имеют срок действия

### Сессии
- Данные пользователя кэшируются в сессии
- Автоматический logout при истечении токена
- Очистка сессии при выходе

## Развертывание

1. Убедитесь, что auth-сервис запущен и доступен
2. Настройте переменные окружения
3. Создайте суперпользователя в auth-сервисе
4. Запустите основной сервис
5. Откройте `/admin` в браузере

## Мониторинг

### Логи
Все ошибки взаимодействия с auth-сервисом логируются. Рекомендуется настроить мониторинг для:
- Ошибок аутентификации
- Недоступности auth-сервиса
- Медленных запросов к auth-сервису

### Метрики
Желательно отслеживать:
- Время ответа auth-сервиса
- Количество неудачных аутентификаций
- Количество активных админ-сессий